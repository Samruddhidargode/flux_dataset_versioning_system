<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Versions — FLUX</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0d1117; --surface: #161b22; --surface2: #21262d;
            --border: #30363d; --text: #e6edf3; --text-dim: #8b949e;
            --accent: #58a6ff; --green: #3fb950; --orange: #d29922;
            --red: #f85149; --purple: #bc8cff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .navbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 32px; display: flex; align-items: center; justify-content: space-between; }
        .navbar .logo { font-size: 20px; font-weight: 700; letter-spacing: 3px; color: var(--accent); }
        .navbar .logo span { color: var(--text-dim); font-weight: 400; font-size: 13px; letter-spacing: 0; margin-left: 12px; }
        .navbar nav a { color: var(--text-dim); text-decoration: none; margin-left: 24px; font-size: 14px; }
        .navbar nav a:hover, .navbar nav a.active { color: var(--accent); }
        .container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }

        /* Selector */
        .compare-selector {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .compare-selector label { font-size: 14px; font-weight: 600; color: var(--text-dim); }
        .compare-selector select {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
        }
        .compare-selector select:focus { outline: none; border-color: var(--accent); }
        .compare-btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 6px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .compare-btn:hover { opacity: 0.85; }
        .compare-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .vs-text { font-size: 18px; font-weight: 700; color: var(--text-dim); }

        /* Results */
        #results { display: none; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section-title .dot { width: 8px; height: 8px; border-radius: 50%; }

        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 24px; }
        .card h3 { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-dim); margin-bottom: 16px; }

        .diff-block {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .diff-add { color: var(--green); }
        .diff-del { color: var(--red); }
        .diff-header { color: var(--purple); }

        /* Metrics grid */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .metric-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 14px;
        }
        .metric-name { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 8px; }
        .metric-values { display: flex; justify-content: space-between; align-items: center; }
        .metric-v { font-size: 16px; font-weight: 600; }
        .metric-arrow { font-size: 14px; margin: 0 8px; }
        .metric-change { font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .change-up { background: rgba(63,185,80,0.15); color: var(--green); }
        .change-down { background: rgba(248,81,73,0.15); color: var(--red); }
        .change-same { background: rgba(139,148,158,0.15); color: var(--text-dim); }

        /* Overlap */
        .overlap-bar-container { margin-top: 16px; }
        .overlap-bar-bg {
            background: var(--surface2);
            border-radius: 8px;
            height: 28px;
            position: relative;
            overflow: hidden;
        }
        .overlap-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--purple));
            border-radius: 8px;
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            min-width: 40px;
        }
        .overlap-stats { display: flex; gap: 24px; margin-top: 12px; flex-wrap: wrap; }
        .overlap-stat-label { font-size: 12px; color: var(--text-dim); }
        .overlap-stat-value { font-size: 18px; font-weight: 700; }

        .loading { text-align: center; padding: 32px; color: var(--text-dim); }
        .error-msg { background: rgba(248,81,73,0.15); border: 1px solid var(--red); border-radius: 8px; padding: 16px; color: var(--red); margin-bottom: 24px; }

        .footer { text-align: center; padding: 24px; color: var(--text-dim); font-size: 12px; border-top: 1px solid var(--border); margin-top: 48px; }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">FLUX <span>Dataset Versioning Dashboard</span></div>
        <nav>
            <a href="/">Dashboard</a>
            <a href="/compare" class="active">Compare</a>
        </nav>
    </div>

    <div class="container">
        <h2 style="margin-bottom: 24px;">Compare Versions</h2>

        <div class="compare-selector">
            <label>Version 1:</label>
            <select id="v1">
                <option value="">Select version...</option>
                {% for v in versions %}
                <option value="{{ v.hash }}">{{ v.label }} ({{ v.short_hash }})</option>
                {% endfor %}
            </select>

            <span class="vs-text">VS</span>

            <label>Version 2:</label>
            <select id="v2">
                <option value="">Select version...</option>
                {% for v in versions %}
                <option value="{{ v.hash }}">{{ v.label }} ({{ v.short_hash }})</option>
                {% endfor %}
            </select>

            <button class="compare-btn" id="compareBtn" onclick="runCompare()">Compare</button>
        </div>

        <div id="loading" class="loading" style="display:none;">Comparing versions...</div>
        <div id="error" class="error-msg" style="display:none;"></div>

        <div id="results">
            <!-- Config Diff -->
            <div class="section-title"><div class="dot" style="background: var(--purple);"></div> Configuration Diff</div>
            <div class="card">
                <div class="diff-block" id="configDiff"></div>
            </div>

            <!-- Metrics Diff -->
            <div class="section-title"><div class="dot" style="background: var(--orange);"></div> Metrics Comparison</div>
            <div class="card">
                <div class="metrics-grid" id="metricsDiff"></div>
            </div>

            <!-- Data Overlap -->
            <div class="section-title"><div class="dot" style="background: var(--green);"></div> Data Overlap</div>
            <div class="card">
                <h3>Jaccard Similarity</h3>
                <div class="overlap-bar-container">
                    <div class="overlap-bar-bg">
                        <div class="overlap-bar-fill" id="overlapBar" style="width: 0%;">0%</div>
                    </div>
                </div>
                <div class="overlap-stats" id="overlapStats"></div>
            </div>

            <!-- Example Differences -->
            <div class="card" id="exampleDiffsCard" style="display:none;">
                <h3>Example Rows Only in V1</h3>
                <div class="diff-block" id="exampleDiffs" style="color: var(--red);"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        FLUX — File-based Lightweight Universal Xplainable Dataset Versioning System
    </div>

    <script>
        async function runCompare() {
            const v1 = document.getElementById('v1').value;
            const v2 = document.getElementById('v2').value;
            if (!v1 || !v2) { alert('Select both versions'); return; }
            if (v1 === v2) { alert('Select two different versions'); return; }

            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const resp = await fetch(`/api/compare?v1=${v1}&v2=${v2}`);
                const data = await resp.json();

                if (data.error) {
                    document.getElementById('error').textContent = data.error;
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                // Config diff
                const diffEl = document.getElementById('configDiff');
                diffEl.innerHTML = colorDiff(data.config_diff);

                // Metrics diff
                const metricsEl = document.getElementById('metricsDiff');
                metricsEl.innerHTML = '';
                const skip = ['created_at', 'created_by'];
                for (const [key, val] of Object.entries(data.metrics_diff)) {
                    if (skip.includes(key)) continue;
                    const v1val = val.v1;
                    const v2val = val.v2;
                    const change = val.change || 0;
                    const pct = val.pct_change || '0.00%';

                    let changeClass = 'change-same';
                    let arrow = '=';
                    if (typeof change === 'number') {
                        if (change > 0) { changeClass = 'change-up'; arrow = '&#9650;'; }
                        else if (change < 0) { changeClass = 'change-down'; arrow = '&#9660;'; }
                    }

                    const name = key.replace(/_/g, ' ');
                    const v1Str = typeof v1val === 'object' ? JSON.stringify(v1val) : v1val;
                    const v2Str = typeof v2val === 'object' ? JSON.stringify(v2val) : v2val;

                    metricsEl.innerHTML += `
                        <div class="metric-item">
                            <div class="metric-name">${name}</div>
                            <div class="metric-values">
                                <span class="metric-v">${v1Str}</span>
                                <span class="metric-arrow">&rarr;</span>
                                <span class="metric-v">${v2Str}</span>
                            </div>
                            <div style="margin-top:8px; text-align:right;">
                                <span class="metric-change ${changeClass}">${arrow} ${pct}</span>
                            </div>
                        </div>`;
                }

                // Overlap
                const overlap = data.data_overlap;
                const jaccard = parseFloat(overlap.jaccard_similarity || 0);
                const pct = (jaccard * 100).toFixed(1);
                const bar = document.getElementById('overlapBar');
                bar.style.width = pct + '%';
                bar.textContent = pct + '%';

                const statsEl = document.getElementById('overlapStats');
                statsEl.innerHTML = `
                    <div><div class="overlap-stat-label">Common Rows</div><div class="overlap-stat-value">${overlap.common_rows || 0}</div></div>
                    <div><div class="overlap-stat-label">Only in V1</div><div class="overlap-stat-value" style="color:var(--red)">${overlap.only_in_v1 || 0}</div></div>
                    <div><div class="overlap-stat-label">Only in V2</div><div class="overlap-stat-value" style="color:var(--green)">${overlap.only_in_v2 || 0}</div></div>
                `;

                // Example diffs
                const exCard = document.getElementById('exampleDiffsCard');
                const exEl = document.getElementById('exampleDiffs');
                const examples = overlap.example_only_in_v1 || [];
                if (examples.length > 0) {
                    exEl.textContent = examples.join('\n');
                    exCard.style.display = 'block';
                } else {
                    exCard.style.display = 'none';
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
            } catch (err) {
                document.getElementById('error').textContent = 'Error: ' + err.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function colorDiff(text) {
            return text.split('\n').map(line => {
                if (line.startsWith('+++') || line.startsWith('---'))
                    return `<span class="diff-header">${esc(line)}</span>`;
                if (line.startsWith('@@'))
                    return `<span class="diff-header">${esc(line)}</span>`;
                if (line.startsWith('+'))
                    return `<span class="diff-add">${esc(line)}</span>`;
                if (line.startsWith('-'))
                    return `<span class="diff-del">${esc(line)}</span>`;
                return esc(line);
            }).join('\n');
        }

        function esc(s) {
            return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
    </script>
</body>
</html>
